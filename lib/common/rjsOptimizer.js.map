{"version":3,"sources":["../../src/common/rjsOptimizer.js"],"names":["args","requirejsDevCfg","runInNewContext","requirejsDev","mergedPaths","Object","assign","paths","keys","forEach","f","replace","bowerCfg","directory","includes","include","exclude","filter","indexOf","push","optimize","out","baseUrl","name","insertRequire","shim","bundles","rjsOptimizer","readFileSync","resolve","JSON","parse","cfg","Promise","reject","output","success","console","log","err","e"],"mappings":";;;;;;;yDA+BA,iBAA4BA,IAA5B;AAAA;AAAA;AAAA;AAAA;AAAA;AACI;AACIC,uCAFR,GAE0B,aAAGC,eAAH,CAAuBC,YAAvB,eAF1B;AAIQC,mCAJR,GAIsBC,OAAOC,MAAP,CAAc,qBAAgBC,KAA9B,EAAqCN,gBAAgBM,KAArD,CAJtB;;AAKIF,+BAAOG,IAAP,CAAYJ,WAAZ,EACKK,OADL,CACa,aAAG;AACRL,wCAAYM,CAAZ,IAAiBN,YAAYM,CAAZ,EAAeC,OAAf,CAAuB,eAAvB,UAA8CC,SAASC,SAAvD,CAAjB;AACH,yBAHL;;AAKA;AACA;AACIC,gCAZR,GAYmB,qBAAgBC,OAZnC;AAaQC,+BAbR,GAakB,CAAC,cAAD,EAAgB,KAAhB,EAAsB,gBAAtB,CAblB;;AAcIX,+BAAOG,IAAP,CAAYJ,WAAZ,EACKa,MADL,CACY;AAAA,mCAAGD,QAAQE,OAAR,CAAgBR,CAAhB,IAAmB,CAAtB;AAAA,yBADZ,EAEKD,OAFL,CAEa,aAAG;AACRK,qCAASK,IAAT,CAAcf,YAAYM,CAAZ,CAAd;AACH,yBAJL;;AAdJ;AAAA,+BAoBUU,SAAS;AACXC,iCAAK,mBADM;AAEXC,qCAAS,QAFE;AAGXC,kCAAM,aAHK;AAIXhB,mCAAOH,WAJI;AAKXW,qCAAS,qBAAgBA,OALd;AAMXS,2CAAe,CAAC,aAAD,CANJ;AAOXC,kCAAMxB,gBAAgBwB,IAPX;AAQXC,qCAAS;AARE,yBAAT,CApBV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;oBAAeC,Y;;;;;AA/Bf;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;;;AAEA,IAAIxB,eAAe,aAAGyB,YAAH,CAAgB,eAAKC,OAAL,CAAa,2BAAb,CAAhB,CAAnB;AACA,IAAMjB,WAAYkB,KAAKC,KAAL,CAAW,aAAGH,YAAH,CAAgB,eAAKC,OAAL,CAAa,UAAb,CAAhB,CAAX,CAAlB;;AAEA,IAAIT,WAAW,SAAXA,QAAW,CAASY,GAAT,EAAa;AACxB,WAAO,IAAIC,OAAJ,CAAY,UAACJ,OAAD,EAAUK,MAAV,EAAmB;AAClCF,YAAIG,MAAJ,GAAaN,OAAb;AACA,YAAI;AACA,gCAAQT,QAAR,CACIY,GADJ,EAEI,UAAUI,OAAV,EAAmB;AACfC,wBAAQC,GAAR,CAAYF,OAAZ;AACAP,wBAAQO,OAAR;AACH,aALL,EAMI,UAAUG,GAAV,EAAe;AACXL,uBAAOK,GAAP;AACH,aARL;AASH,SAVD,CAUE,OAAOC,CAAP,EAAU;AACRN,mBAAOM,CAAP;AACH;AAEJ,KAhBM,CAAP;AAiBH,CAlBD;;kBAsDeb,Y","file":"rjsOptimizer.js","sourcesContent":["import shell from 'shelljs'\nimport require from 'requirejs'\nimport path from 'path'\nimport fs from 'fs'\nimport vm from 'vm'\n\nimport {requireJsConfig} from '../config/rjs'\n\nvar requirejsDev = fs.readFileSync(path.resolve('src/app/require.config.js'))\nconst bowerCfg =  JSON.parse(fs.readFileSync(path.resolve('.bowerrc')))\n\nlet optimize = function(cfg){\n    return new Promise((resolve, reject)=>{\n        cfg.output = resolve\n        try {\n            require.optimize(\n                cfg,\n                function (success) {\n                    console.log(success)\n                    resolve(success)\n                },\n                function (err) {\n                    reject(err)\n                });\n        } catch (e) {\n            reject(e)\n        }\n\n    })\n}\n\nasync function rjsOptimizer(args) {\n    //Take bower_modules from src\n    let requirejsDevCfg = vm.runInNewContext( `${requirejsDev}; require`)\n\n    let mergedPaths = Object.assign(requireJsConfig.paths, requirejsDevCfg.paths)\n    Object.keys(mergedPaths)\n        .forEach(f=>{\n            mergedPaths[f] = mergedPaths[f].replace('bower_modules', `../${bowerCfg.directory}`)\n        })\n\n    // Includes all modules used explicity\n    // Remains the native requireJS deps that are excluded\n    let includes = requireJsConfig.include\n    let exclude = [\"jqueryui-amd\",\"ojs\",\"ojtranslations\"]\n    Object.keys(mergedPaths)\n        .filter(f=>exclude.indexOf(f)<0)\n        .forEach(f=>{\n            includes.push(mergedPaths[f])\n        })\n\n    await optimize({\n        out: './temp/scripts.js',\n        baseUrl: './temp',\n        name: 'app/startup',\n        paths: mergedPaths,\n        include: requireJsConfig.include,\n        insertRequire: ['app/startup'],\n        shim: requirejsDevCfg.shim,\n        bundles: {}\n    })\n}\n\n\n\nexport default rjsOptimizer;"]}